const GEMINI_API_KEY = Deno.env.get('GEMINI_API_KEY')!

const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

const SYSTEM_PROMPT = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÅ‡∏´‡πà‡∏á‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß" ‡∏´‡∏°‡∏≠‡∏î‡∏π‡∏ú‡∏π‡πâ‡πÄ‡∏õ‡∏µ‡πà‡∏¢‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ö‡∏∞‡∏ç‡∏≤‡∏ì‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏•‡∏±‡∏á ‡∏ó‡∏£‡∏á‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏£‡πâ‡∏ô‡∏•‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏Ç‡∏ô‡∏á ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà:
- ‡πÇ‡∏´‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÇ‡∏ö‡∏£‡∏≤‡∏ì (‡πÑ‡∏ó‡∏¢/‡∏à‡∏µ‡∏ô/‡∏™‡∏≤‡∏Å‡∏•)
- ‡πÑ‡∏û‡πà‡∏ó‡∏≤‡πÇ‡∏£‡∏ï‡πå (Tarot) 
- ‡πÄ‡∏•‡∏Ç‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (Numerology)
- ‡∏Æ‡∏ß‡∏á‡∏à‡∏∏‡πâ‡∏¢‡πÅ‡∏•‡∏∞‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ

‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á" (Persona):
- ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡∏Ç‡∏•‡∏±‡∏á ‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏Å‡∏£‡∏á‡∏Ç‡∏≤‡∏°‡πÅ‡∏ï‡πà‡πÅ‡∏ù‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏ï‡∏ï‡∏≤ (Authoritative & Mystical)
- ‚õî ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡∏à‡∏≤‡πÄ‡∏à‡∏∑‡πâ‡∏≠‡∏¢‡πÅ‡∏à‡πâ‡∏ß ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ‡πÄ‡∏à‡πä‡∏≤‡∏∞‡πÅ‡∏à‡πä‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏∞", "‡∏î‡∏¥‡∏â‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞", "‡∏°‡∏≤‡∏Ñ‡πà‡∏∞‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏à‡∏∞‡∏î‡∏π‡πÉ‡∏´‡πâ")
- ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ô‡πà‡∏ô ‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô ‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏ñ‡∏∂‡∏á‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏ä‡πà‡∏ô "‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è..." ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏û‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏ä‡∏∞‡∏ï‡∏≤‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß..."
- ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏´‡∏•‡∏∏‡∏î‡∏û‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏∑‡∏≠‡∏®‡∏µ‡∏• ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏î‡∏π‡∏î‡∏ß‡∏á ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏µ‡πâ‡∏ä‡∏∞‡∏ï‡∏≤ 

‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
1. ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢ ‡∏î‡∏π‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö
2. ‡πÉ‡∏ä‡πâ Emoji ‡πÅ‡∏ô‡∏ß‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏• (üîÆ‚ú®üåüüëÅÔ∏èüåëüóùÔ∏è) ‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡∏à‡∏ô‡πÄ‡∏•‡∏≠‡∏∞‡πÄ‡∏ó‡∏≠‡∏∞
3. ‡πÉ‡∏ä‡πâ Emoji ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (üîÆ‚ú®üåüüí´üÉèüåô‚≠ê)
4. ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î:
   - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏Å: ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 
   - ‚õî ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î (‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠) 
   - ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ "‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏ó‡∏≤‡πÇ‡∏£‡∏ï‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á (Virtual Tarot)" ‡πÇ‡∏î‡∏¢‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏û‡πà‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
   - ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô ‡πÇ‡∏´‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏≠‡∏¥‡∏á‡∏£‡∏≤‡∏®‡∏µ (Sun Sign), ‡πÄ‡∏•‡∏Ç‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå, ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏û‡πà‡∏ó‡∏≤‡πÇ‡∏£‡∏ï‡πå ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
5. ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏°‡πâ‡∏î‡∏ß‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ‡∏Å‡πá‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥
6. ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà 2 ‡πÅ‡∏•‡∏∞ 3: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏ñ‡∏≤‡∏°‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏ã‡πâ‡∏≥ (‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ" ‡∏≠‡∏µ‡∏Å) ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏£‡∏á‡πÜ ‡πÄ‡∏•‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°
7. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á
8. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 3-5 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏∞
9. ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö: (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1-2 ‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ô‡∏à‡∏ô‡∏™‡∏±‡∏ö‡∏™‡∏ô)
   ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤ ‚Üí ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å ‚Üí ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥/‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥ ‚Üí ‡πÄ‡∏•‡∏Ç‡∏°‡∏á‡∏Ñ‡∏•/‡∏™‡∏µ‡∏°‡∏á‡∏Ñ‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
10. ‚ö†Ô∏è ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏î‡∏π‡∏î‡∏ß‡∏á‡πÄ‡∏•‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á IT, ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ) ‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡πà‡∏∞ ‡∏î‡∏¥‡∏â‡∏±‡∏ô‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ üîÆ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏ß‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞" ‡∏≠‡∏¢‡πà‡∏≤‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏ß‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ù‡∏∑‡∏ô‡πÜ`

Deno.serve(async (req: Request) => {
    // Handle CORS preflight
    if (req.method === 'OPTIONS') {
        return new Response('ok', { headers: corsHeaders })
    }

    try {
        const { messages, gender = 'female' } = await req.json()

        if (!messages || !Array.isArray(messages) || messages.length === 0) {
            return new Response(
                JSON.stringify({ error: 'messages array is required' }),
                { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
            )
        }

        if (!GEMINI_API_KEY) {
            return new Response(
                JSON.stringify({ error: 'GEMINI_API_KEY not configured' }),
                { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
            )
        }

        // Dynamic gender persona
        const genderAddition = gender === 'male'
            ? '\n\n‡πÄ‡∏û‡∏®‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏≠‡∏î‡∏π: ‡∏ä‡∏≤‡∏¢ ‚Äî ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏° "‡∏ú‡∏°" ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ "‡∏Ñ‡∏£‡∏±‡∏ö" ‡∏ï‡∏•‡∏≠‡∏î ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ "‡∏Ñ‡πà‡∏∞" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏î‡∏¥‡∏â‡∏±‡∏ô" ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡∏û‡∏π‡∏î‡∏à‡∏≤‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢'
            : '\n\n‡πÄ‡∏û‡∏®‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏≠‡∏î‡∏π: ‡∏´‡∏ç‡∏¥‡∏á ‚Äî ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏° "‡∏î‡∏¥‡∏â‡∏±‡∏ô" ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ "‡∏Ñ‡πà‡∏∞/‡∏ô‡∏∞‡∏Ñ‡∏∞" ‡∏ï‡∏•‡∏≠‡∏î ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ "‡∏Ñ‡∏£‡∏±‡∏ö" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ú‡∏°" ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡∏û‡∏π‡∏î‡∏à‡∏≤‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á‡πÑ‡∏ó‡∏¢'

        const fullPrompt = SYSTEM_PROMPT + genderAddition

        // Build Gemini API request body
        // Convert messages [{role: 'user'|'model', text: '...'}] to Gemini format
        const contents = messages.map((msg: { role: string; text: string }) => ({
            role: msg.role === 'user' ? 'user' : 'model',
            parts: [{ text: msg.text }],
        }))

        const geminiBody = {
            system_instruction: {
                parts: [{ text: fullPrompt }],
            },
            contents,
            generationConfig: {
                temperature: 0.9,
                topP: 0.95,
                topK: 40,
                maxOutputTokens: 4096,
            },
            safetySettings: [
                { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_ONLY_HIGH' },
                { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_ONLY_HIGH' },
                { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_ONLY_HIGH' },
                { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_ONLY_HIGH' },
            ],
        }

        const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`

        const geminiRes = await fetch(geminiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(geminiBody),
        })

        if (!geminiRes.ok) {
            const errorText = await geminiRes.text()
            console.error('Gemini API error:', geminiRes.status, errorText)
            return new Response(
                JSON.stringify({ error: 'AI service error', details: errorText }),
                { status: 502, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
            )
        }

        const geminiData = await geminiRes.json()
        const reply = geminiData?.candidates?.[0]?.content?.parts?.[0]?.text || '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè'

        return new Response(
            JSON.stringify({ reply }),
            { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        )

    } catch (err) {
        console.error('Fortune teller error:', err)
        return new Response(
            JSON.stringify({ error: 'Internal server error' }),
            { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        )
    }
})
